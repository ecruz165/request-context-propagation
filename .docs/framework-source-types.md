# Request Context Propagation Framework - Source Type Support Matrix

## üìä Source Type Support Matrix

| Source Type | Upstream Response | Downstream Request | Downstream Response | Observability   | Notes                                                |
|-------------|-------------------|--------------------|---------------------|-----------------|------------------------------------------------------|
| **HEADER**  | ‚úÖ                 | ‚úÖ                  | ‚úÖ                   | ‚úÖ               | Full bidirectional support                           |
| **COOKIE**  | ‚úÖ                 | ‚ùå                  | ‚ùå                   | ‚úÖ               | Upstream-only (security best practice)               |
| **QUERY**   | ‚ùå                 | ‚úÖ                  | ‚ùå                   | ‚úÖ               | Request-only (query params don't exist in responses) |
| **BODY**    | ‚ùå                 | ‚ùå                  | ‚úÖ                   | ‚úÖ               | JSON extraction (downstream response only)           |
| **CLAIM**   | ‚ùå                 | ‚ùå                  | ‚ùå                   | ‚úÖ               | JWT claims from Spring Security context (extract-only) |
| **PATH**    | ‚ùå                 | ‚ùå                  | ‚ùå                   | ‚úÖ               | URL path variables (request-only)                    |
| **CONTEXT** | ‚ùå                 | ‚ùå                  | ‚ùå                   | ‚úÖ               | Framework-provided for observability only            |

> **Note**: All source types provide extraction as the core framework service. The matrix above shows propagation and enrichment capabilities.

## üîç Detailed Source Type Descriptions

### **HEADER** - HTTP Headers
- **Source**: Incoming request headers
- **Upstream Response**: ‚úÖ Add to response headers
- **Downstream Request**: ‚úÖ Propagate to downstream services
- **Downstream Response**: ‚úÖ Extract from downstream responses
- **Use Cases**: User IDs, tenant IDs, correlation IDs, API keys
- **Example**: `X-User-ID`, `X-Tenant-ID`, `X-Request-ID`

### **COOKIE** - HTTP Cookies
- **Source**: Incoming request cookies
- **Upstream Response**: ‚úÖ Set cookies in responses (security best practice)
- **Downstream Propagation**: ‚ùå Not propagated to downstream services (security)
- **Use Cases**: Session IDs, user preferences, client state
- **Security**: Cookies are upstream-only to prevent security issues
- **Example**: `sessionId`, `userPreferences`

### **QUERY** - Query Parameters
- **Source**: URL query parameters
- **Downstream Request**: ‚úÖ Add as query parameters
- **Limitations**: ‚ùå No response propagation (queries don't exist in responses)
- **Use Cases**: API versions, format preferences, pagination
- **Example**: `?version=v1&format=json`

### **CLAIM** - JWT Claims
- **Source**: Spring Security JWT context
- **Propagation**: ‚ùå Extract-only (claims are authentication data)
- **Features**: Supports nested claims with dot notation
- **Use Cases**: User roles, permissions, nested user data
- **Example**: `user.email`, `roles`, `permissions`


### **PATH** - URL Path Variables
- **Source**: URL path segments
- **Limitations**: ‚ùå Request-only (no propagation)
- **Use Cases**: Resource IDs, tenant identifiers in URLs
- **Example**: `/users/{userId}/tenants/{tenantId}`

### **BODY** - Downstream Response Body Only
- **Source**: Downstream service JSON responses using JSONPath
- **Limitations**: ‚ùå No upstream request body extraction, ‚ùå No propagation (extract-only), downstream inbound only
- **Features**:
  - Supports nested JSON extraction with JSONPath
  - Can extract entire JSON response (use `$` or `.` as key)
  - Supports complex JSONPath expressions
  - Downstream response extraction only
- **Use Cases**:
  - Service response data capture
  - API response field extraction
  - Downstream service monitoring
- **Examples**:
  - `$.user.id` - Extract user ID from downstream response
  - `$.data[0].name` - Extract first item's name from response array
  - `$` or `.` - Extract entire downstream JSON response





### **Context Fields** - Framework-Provided
- **Source**: Automatically generated by framework
- **Propagation**: ‚ùå Observability only (server-side use)
- **Features**: No extraction needed, always available for observability
- **Use Cases**: Logging, metrics, tracing - handler method info, computed values
- **Example**: `apiHandler: "UserController/getUser"` (for MDC, metrics tags, etc.)

## üéØ Enrichment Type Support

| Enrichment Type | Description | Supported Sources |
|-----------------|-------------|-------------------|
| **HEADER** | Add to HTTP headers | All propagatable sources |
| **QUERY** | Add to query parameters | All propagatable sources |
| **COOKIE** | Add to cookies | ‚úÖ Upstream responses only (security) |


## üîß Configuration Examples

### **Bidirectional Header Propagation**
```yaml
requestId:
  upstream:
    inbound:
      source: HEADER
      key: X-Request-ID
    outbound:
      enrichAs: HEADER
      key: X-Request-ID
  downstream:
    outbound:
      enrichAs: HEADER
      key: X-Request-ID
```

### **Upstream-Only Cookie Extraction**
```yaml
sessionId:
  upstream:
    inbound:
      source: COOKIE
      key: JSESSIONID
  # No downstream propagation for security
```

### **Context Field for Observability Only**
```yaml
apiHandler:
  observability:
    logging:
      mdcKey: "api.handler"
    metrics:
      includeInMetrics: true
      metricName: "api_handler_requests"
    tracing:
      includeInTracing: true
      tracingKey: "api.handler"
  # Framework automatically provides value
  # No propagation - observability only
```

### **BODY Downstream Response Extraction**
```yaml
# Extract specific field from downstream JSON response
userProfileData:
  downstream:
    inbound:
      source: BODY
      key: "$.user.profile.email"  # JSONPath to extract email
  observability:
    includeInLogs: true

# Extract entire downstream JSON response
fullApiResponse:
  downstream:
    inbound:
      source: BODY
      key: "$"  # Extract entire JSON response
  observability:
    includeInLogs: true

# Extract array element from downstream response
firstResultId:
  downstream:
    inbound:
      source: BODY
      key: "$.results[0].id"  # Extract ID from first result
```

## üöÄ Framework Features

### **Universal Observability**
All source types support:
- ‚úÖ **Logging**: MDC integration with configurable keys
- ‚úÖ **Metrics**: Configurable cardinality levels (LOW/MEDIUM/HIGH)
- ‚úÖ **Tracing**: Span tag integration with custom tag names

### **Security Features**
- ‚úÖ **Sensitive Data Masking**: Configurable per field
- ‚úÖ **Required Field Validation**: Fail fast for missing required data
- ‚úÖ **Default Values**: Fallback values for optional fields
- ‚úÖ **Cookie Security**: Upstream-only to prevent propagation

### **Performance Optimizations**
- ‚úÖ **Early Extraction**: Pre-authentication phase for non-auth sources
- ‚úÖ **Lazy Evaluation**: Only extract configured fields
- ‚úÖ **Caching**: Request-scoped context storage
- ‚úÖ **Async Support**: HttpServletRequest storage for thread safety